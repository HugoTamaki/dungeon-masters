<div class="container">
  <div class="message-container"></div>
  <div class="row content">
    <div class="col-lg-8 col-sm-12 chapter">
      <h3><%= t('stories.read.chapter') %> <%= @chapter.reference %></h3>
      <div class="chapter-image">
        <p>
          <%= image_tag @chapter.image(:normal), class: "img-responsive center-block" if @chapter.image.present? %>
        </p>
      </div>
      <div class="chapter-content">
        <p>
          <%= simple_format @chapter.content %>
        </p>
      </div>
      <% if @chapter.monsters.present? %>
      <hr/>
        <% @chapter.monsters.each do |monster| %>
          <p>
            <%= t('stories.read.monster') %>: <%= monster.name %>
          </p>
          <p>
            <%= t('stories.read.skill') %>: <span id="<%= monster.name %>_skill"><%= monster.skill %></span>
          </p>
          <p>
            <%= t('stories.read.energy') %>: <span id="<%= monster.name %>_energy"><%= monster.energy %></span>
          </p>
          <hr/>
        <% end %>
        <p>
          <%= button_tag t('stories.read.combat'), class: "btn btn-primary", id: "combat" %>
        </p>
        <div id="combat-result"></div>
      <% end %>
      <div id="chapter-buttons">
        <% @chapter.decisions.each do |decision| %>
          <% button_opts = {reference: decision.destiny_num.to_s, id: @story} %>
          <% disabled = "disabled" if @chapter.monsters.present? %>
          <% disabled ||= "disabled" if  %>
          <% if decision.item_validator? %>
            <% disabled ||= "disabled" if Adventurer.dont_have_item(@adventurer,decision.item_validator) %>
          <% end %>
          <p>
            <%= link_to  "#{t('stories.read.chapter')} #{decision.destiny_num}",
              read_stories_path(button_opts),
              class: "btn btn-primary #{disabled}" unless Chapter.by_story(@story).where(reference: "#{decision.destiny_num}").empty? %>
          </p>
        <% end %>
      </div>
    </div>
    <% if @adventurer.present? %>
      <%= render partial: 'adventurers/adventurer' %>
    <% end %>
  </div>
</div>

<% if @chapter.monsters.present? %>
  <script type="text/javascript">
    $(document).ready(function() {

      $("#combat").click(function() {
        var result = "";
        var finish;
        var morreu = false;
        var adventurer_skill = <%= @adventurer.skill %>;
        var adventurer_energy = <%= @adventurer.energy %>;
        var adventurer_luck = <%= @adventurer.luck %>;

        <% @chapter.monsters.each do |monster| %>
          var <%= monster.name.parameterize.underscore %>_skill = <%= monster.skill %>;
          var <%= monster.name.parameterize.underscore %>_energy = <%= monster.energy %>;

          finish = false;

          while (!finish) {
            var enemyDice1 = 1 + Math.floor(Math.random()*6);
            var enemyDice2 = 1 + Math.floor(Math.random()*6);
            var enemyAttackPower = enemyDice1 + enemyDice2 + <%= monster.name.parameterize.underscore %>_skill;
            var advDice1 = 1 + Math.floor(Math.random()*6);
            var advDice2 = 1 + Math.floor(Math.random()*6);
            var adventurerAttackPower = advDice1 + advDice2 + adventurer_skill;

            if (enemyAttackPower > adventurerAttackPower) {
              result += "<p>"+ "<%= @adventurer.name %> <%= t('stories.read.attack_power') %> - "+ advDice1 + " + " + advDice2 + " + " + adventurer_skill + " = "+ adventurerAttackPower + "<strong><br>" + "<%= monster.name %> <%= t('stories.read.attack_power') %> - "+ enemyDice1 + " + " + enemyDice2 + " + " + <%= monster.name.parameterize.underscore %>_skill + " = " + enemyAttackPower + "</strong></p><hr>";
              adventurer_energy -= 2;
              if (adventurer_energy < 1) {
                finish = true;
                morreu = true;
                result += "<p><%= t('stories.read.you_died') %></p>";
                $("#combat-result").html(result);
                return;
              } else if (<%= monster.name.parameterize.underscore %>_energy < 1) {
                finish = true;
                result += "<p><%= monster.name %> <%= t('stories.read.died') %></p>";
              }
            } else if (enemyAttackPower < adventurerAttackPower) {
              result += "<p><strong>"+ "<%= @adventurer.name %> <%= t('stories.read.attack_power') %> - "+ advDice1 + " + " + advDice2 + " + " + adventurer_skill + " = "+ adventurerAttackPower + "</strong> <i class='fa fa-check fa-1'></i><br>" + "<%= monster.name %> <%= t('stories.read.attack_power') %> - "+ enemyDice1 + " + " + enemyDice2 + " + " + <%= monster.name.parameterize.underscore %>_skill + " = " + enemyAttackPower + "</p><hr>";
              <%= monster.name.parameterize.underscore %>_energy -= 2;
              if (adventurer_energy < 1) {
                finish = true;
                morreu = true;
                result += "<p><%= t('stories.read.you_died') %></p>";
                $("#combat-result").html(result);
                return;
              } else if (<%= monster.name.parameterize.underscore %>_energy < 1) {
                finish = true;
                result += "<p><%= monster.name %> <%= t('stories.read.died') %></p>";
              }
            }
          }
        <% end %>
        $("#combat-result").html(result);
        $("#adventurer_energy").html(adventurer_energy);
        if (!morreu) {
          $('#chapter-buttons').children().find('a').removeClass('disabled');
        }
        $("#combat").addClass('disabled');
        //resizeHeight($("#combat-result").height());

        $.ajax({
          url: "/adventurers/update_adventurer_status?adventurer_skill="+adventurer_skill+"&adventurer_energy="+adventurer_energy+"&adventurer_luck="+adventurer_luck,
          type: 'PUT',
          success: function() {
            $(".message-container").html("<p class='message'>Adventurer updated.</p>");
            setTimeout("$('.message').fadeOut()", 3000);
          },
          error: function() {
            
          }
        });

      });
    });
  </script>
<% end %>
