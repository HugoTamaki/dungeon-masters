
<%= javascript_include_tag "resize" %>
<div class="message-container"></div>
<div class="content">
  <div class="chapter">
    <h3>Chapter <%= @chapter.reference %></h3>
    <div class="chapter-image">
      <p>
        <%= image_tag @chapter.image if @chapter.image.present? %>
      </p>
    </div>
    <div class="chapter-content">
      <p>
        <%= simple_format @chapter.content %>
      </p>
    </div>
    <% if @chapter.monsters.present? %>
    <hr/>
      <% @chapter.monsters.each do |monster| %>
        <p>
          Monster: <%= monster.name %>
        </p>
        <p>
          Skill: <span id="<%= monster.name %>_skill"><%= monster.skill %></span>
        </p>
        <p>
          Energy: <span id="<%= monster.name %>_energy"><%= monster.energy %></span>
        </p>
        <hr/>
      <% end %>
      <p>
        <%= button_tag "Combat!", class: "btn btn-primary", id: "combat" %>
      </p>
      <div id="combat-result"></div>
    <% end %>
    <% @chapter.decisions.each do |decision| %>
      <% button_opts = {reference: decision.destiny_num.to_s, id: @story} %>
      <p>
        <%= link_to "Chapter #{decision.destiny_num}",
          read_stories_path(button_opts),
          class: "btn btn-primary" unless Chapter.by_story(@story).where(reference: "#{decision.destiny_num}").empty? %>
      </p>
    <% end %>
  </div>
  <% if @adventurer.present? %>
    <div class="adventurer">
      <h3>Adventurer sheet</h3>
      <p>Name: <span id="adventurer_name"><%= @adventurer.name %></span></p>
      <p>Skill: <span id="adventurer_skill"><%= @adventurer.skill %></span></p>
      <p>Energy: <span id="adventurer_energy"><%= @adventurer.energy %></span></p>
      <p>Luck: <span id="adventurer_luck"><%= @adventurer.luck %></span></p>
      <% if @adventurer.items.present? %>
        <h3>Adventurer Items</h3>
        <% @adventurer.items.each do |item| %>
        <p><%= item.name %> </p>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>

<% if @chapter.monsters.present? %>
  <script type="text/javascript">
    $(document).ready(function() {

      $("#combat").click(function() {
        var result = "";
        var finish;
        var morreu = false;
        var adventurer_skill = <%= @adventurer.skill %>;
        var adventurer_energy = <%= @adventurer.energy %>;
        var adventurer_luck = <%= @adventurer.luck %>;

        <% @chapter.monsters.each do |monster| %>
          var <%= monster.name.downcase.tr(" ","_") %>_skill = <%= monster.skill %>;
          var <%= monster.name.downcase.tr(" ","_") %>_energy = <%= monster.energy %>;

          finish = false;

          while (!finish) {
            console.log("adventurer energy: "+adventurer_energy);
            var enemyAttackPower = 2 + Math.floor(Math.random()*11) + 12 + <%= monster.name.downcase.tr(" ","_") %>_skill;
            var adventurerAttackPower = 2 + Math.floor(Math.random()*11) + 12 + adventurer_skill;

            if (enemyAttackPower > adventurerAttackPower) {
              result += "<p>"+ "<%= @adventurer.name %>" +" Attack Power - "+ adventurerAttackPower +"<strong> "+ "<%= monster.name %>" +" - Attack Power - "+ enemyAttackPower +"</strong><p>";
              adventurer_energy -= 2;
              if (adventurer_energy < 1) {
                finish = true;
                morreu = true;
                result += "<p>You died!</p>";
                $("#combat-result").html(result);
                return;
              } else if (<%= monster.name.downcase.tr(" ","_") %>_energy < 1) {
                finish = true;
                result += "<p><%= monster.name %> died!</p>";
              }
            } else if (enemyAttackPower < adventurerAttackPower) {
              result += "<p><strong>"+ "<%= @adventurer.name %>" +" Attack Power - "+ adventurerAttackPower +"</strong> "+ "<%= monster.name %>" +" - Attack Power - "+ enemyAttackPower +"<p>";
              <%= monster.name.downcase.tr(" ","_") %>_energy -= 2;
              if (adventurer_energy < 1) {
                finish = true;
                morreu = true;
                result += "<p>You died!</p>";
                $("#combat-result").html(result);
                return;
              } else if (<%= monster.name.downcase.tr(" ","_") %>_energy < 1) {
                finish = true;
                result += "<p><%= monster.name %> died!</p>";
              }
            }
          }
        <% end %>
        $("#combat-result").html(result);
        $("#adventurer_energy").html(adventurer_energy);
        //resizeHeight($("#combat-result").height());

        $.ajax({
          url: "/adventurers/update_adventurer_status?adventurer_skill="+adventurer_skill+"&adventurer_energy="+adventurer_energy+"&adventurer_luck="+adventurer_luck,
          type: 'PUT',
          success: function() {
            $(".message-container").html("<p class='message'>Adventurer updated.</p>");
            setTimeout("$('.message').fadeOut()", 3000);
          },
          error: function() {
            
          }
        });

      });
    });
  </script>
<% end %>

