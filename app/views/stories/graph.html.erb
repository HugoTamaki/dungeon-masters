<h3>Graph</h3>
<%= javascript_include_tag "sigma" %>

<div id="actions">
  <%= simple_form_for(@story) do |f| %>
    <%= f.submit "Finish Editing", class: "btn btn-primary" %>
    <%= f.submit "Edit Chapters", class: "btn btn-primary" %>
    <%= f.submit "Edit Items", class: "btn btn-primary" %>
    <%= f.submit "Edit Special Attributes", class: "btn btn-primary" %>
    <%= f.submit "Save", class: "btn btn-primary" %>
  <% end %>
</div>

<div class="sigma" id="sig"></div>
<div class="not-used"></div>

<script type="text/javascript">
  $(document).ready(function(){

    $.ajax({
      url: "graph_json?id="+<%= @story.id %>,
      type: "GET",
      dataType: "json",
      success: function(data) {

         if (data["valid"]) {
           var sigRoot = document.getElementById('sig');
           var sigInst = sigma.init(sigRoot).drawingProperties({
             defaultLabelColor: '#ccc',
             defaultLabelSize: 10,
             font: 'Arial',
             edgeColor: 'source',
             defaultEdgeType: 'curve',
             defaultEdgeArrow: 'target',
             labelThreshold: 0
           }).graphProperties({
             minNodeSize: 0.5,
             maxNodeSize: 5,
             maxEdgeSize: 3
           }).mouseProperties({
             maxRatio: 32
           });

           for (var i=0;i<data["references"].length;i++) {
             sigInst.addNode('cap'+data["references"][i], {
               label: 'cap '+data["references"][i],
               color: data["infos"][i][2],
               x: data["infos"][i][0],
               y: data["infos"][i][1]
             }).draw();
           }

           for (var k=0;k<data["chapter_destinies"].length;k++) {
             if ((data["chapter_destinies"][k].length != 0) && data["valid"][k]) {
               for (var l=1;l<data["chapter_destinies"][k].length;l++) {
                 sigInst.addEdge('cap'+data["chapter_destinies"][k][0]+'_cap'+data["chapter_destinies"][k][l], 'cap'+data["chapter_destinies"][k][0], 'cap'+data["chapter_destinies"][k][l]).draw();
               }
             }
           }
        $(".not-used").html("<p><strong>Not Used Chapters: "+data["not_used"]+"</strong></p>");
        // var notUsed = "";
        // for (i=1;i<data["not_used"].length-1;i++) {
        //   notUsed += data["not_used"][i] + ", ";
        //   i%30==0 ? notUsed += "<br/>" : "";
        // }
        // $(".not-used").html(notUsed);
        
        // change color of other nodes and edges to grey when mouseover
        var greyColor = '#666';
        sigInst.bind('overnodes',function(event){
          var nodes = event.content;
          var neighbors = {};
          sigInst.iterEdges(function(e){
            if(nodes.indexOf(e.source)<0 && nodes.indexOf(e.target)<0){
              if(!e.attr['grey']){
                e.attr['true_color'] = e.color;
                e.color = greyColor;
                e.attr['grey'] = 1;
              }
            }else{
              e.color = e.attr['grey'] ? e.attr['true_color'] : e.color;
              e.attr['grey'] = 0;

              neighbors[e.source] = 1;
              neighbors[e.target] = 1;
            }
          }).iterNodes(function(n){
            if(!neighbors[n.id]){
              if(!n.attr['grey']){
                n.attr['true_color'] = n.color;
                n.color = greyColor;
                n.attr['grey'] = 1;
              }
            }else{
              n.color = n.attr['grey'] ? n.attr['true_color'] : n.color;
              n.attr['grey'] = 0;
            }
          }).draw(2,2,2);
        }).bind('outnodes',function(){
          sigInst.iterEdges(function(e){
            e.color = e.attr['grey'] ? e.attr['true_color'] : e.color;
            e.attr['grey'] = 0;
          }).iterNodes(function(n){
            n.color = n.attr['grey'] ? n.attr['true_color'] : n.color;
            n.attr['grey'] = 0;
          }).draw(2,2,2);
        });

      }
    }
  });

  });
</script>