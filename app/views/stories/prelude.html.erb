<div class="container prelude_div">
  <div class="row">
    <div class="col-lg-4">
      <div class="image">
        <%= image_tag @story.cover(:index_cover), class: "img-responsive center" %>
      </div>      
    </div>
    <div class="col-lg-8">
      <h3><%= t('stories.prelude.title') %></h3>

      <% if current_user && @story.user != current_user %>
        <% if current_user.favorites.include?(@story) %>
          <%= link_to "", favorite_story_path(@story, type: "unfavorite"), method: :put, class: 'btn btn-primary fa fa-star' %>
        <% else %>
          <%= link_to "", favorite_story_path(@story, type: "favorite"), method: :put, class: 'btn btn-primary favorite fa fa-star-o' %>
        <% end %>
      <% end %>

      <div class="resume">
        <% unless @story.prelude.empty? %>
          <%= simple_format @story.prelude %>
        <% end %>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-12">
      <!-- fazendo form para aventureiro -->
      <%= simple_form_for @adventurer do |f| %>
        <div>
          <%= f.input :skill, label: t('stories.prelude.skill'), as: :string, html_input: { id: "adventurer_skill" }, disabled: true %>
          <%= f.input :energy, label: t('stories.prelude.energy'), as: :string, html_input: { id: "adventurer_energy" }, disabled: true  %>
          <%= f.input :luck, label: t('stories.prelude.luck'), as: :string, html_input: { id: "adventurer_luck" }, disabled: true %>
          <%= f.hidden_field :user_id, value: current_user.id %>
          <%= f.hidden_field :name, value: current_user.name %>
          <%= hidden_field_tag :story_id, @story.id %>
          <%= hidden_field_tag :reference, "1" %>
        
          <%= f.submit t('stories.prelude.chapter') + " 1", id: 'story-start', story_id: @story.id, class: "btn btn-primary disabled" unless @story.chapters.where(reference: "1").empty? %>
        </div>
      <% end %>
      <div id="dice-container">
        <%= button_tag t('stories.prelude.roll_dices'), class: "btn btn-primary", id: "generator" %>
      </div>
      <!-- fim do form -->
    </div>
  </div>
  <div class="row">
    <div class="col-lg-12">
      <h2>Comentários</h2>
      <% @story.comments.each do |comment| %>
        <div class="comment">
          <div class="comment-author">
            <% if comment.user %>
              <p>Autor: <%= link_to comment.user.name, profile_path(comment.user) %></p>
            <% else %>
              <p>Autor: Not found</p>
            <% end %>
          </div>
          <div class="comment-content">
            <p><%= comment.content.gsub(/\n/, '<br/>').html_safe %></p>
          </div>
        </div>
        <hr>
      <% end %>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-12 comment-form">
      <%= simple_form_for([@story, @story.comments.build]) do |f| %>
        <div class="form-group">
          <%= f.input :content, label: "Novo comentário", input_html: { rows: 10, class: 'form-control' } %>
        </div>
        <div class="form-group">
          <%= f.submit "Criar comentário", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
<%# button_opts = {reference: "1", id: @story} %>
<%#= link_to "Chapter 1",
                    read_stories_path(button_opts),
                    class: "btn btn-primary" unless @story.chapters.where(reference: "1").empty? %>
<script type="text/javascript">

  $(document).ready(function() {

    $("#generator").click(function() {
      var skill = 1 + Math.floor(Math.random()*6) + 6;
      var energy = 2 + Math.floor(Math.random()*11) + 12;
      var luck = 1 + Math.floor(Math.random()*6) + 6;

      $("#adventurer_skill").attr("value", skill);
      $("#adventurer_energy").attr("value", energy);
      $("#adventurer_luck").attr("value", luck);
      $("#story-start").removeClass('disabled');
      $("#generator").addClass('disabled');
      
      $(".new_adventurer").submit(function(){
        $("#adventurer_skill").removeProp('disabled');
        $("#adventurer_energy").removeProp('disabled');
        $("#adventurer_luck").removeProp('disabled');
      });
    });

    
  });

</script>
