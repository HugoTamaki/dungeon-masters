<div class="container">
  <p>
    <h3><%= @story.title %></h3>
  </p>

  <div id="tabs">
    <ul>
      <li><a href="#tabs-1"><%= t('tabs.chapters') %></a></li>
      <li><a href="#tabs-2"><%= t('tabs.special_attributes') %></a></li>
      <li><a href="#tabs-3"><%= t('tabs.items') %></a></li>
      <li><a href="#tabs-4"><%= t('tabs.story') %></a></li>
      <li><a href="#tabs-5"><%= t('tabs.graph') %></a></li>
    </ul>
    <div id="tabs-1">
      <% @chapters.each do |chapter| %>
        <div class="chapter-fields">
          <h3><%= t('stories.show.chapter') %> <%= chapter.reference %></h3>
          <p>
            <%= t('stories.show.content') %> <%= simple_format chapter.content %>
          </p>
          <p>
            <%= image_tag chapter.image if chapter.image.present? %>
          </p>
          <% if chapter.decisions.present? %>
            <div class="decision-fields">
              <h3><%= t('stories.show.decisions') %></h3>
              <% chapter.decisions.each do |decision| %>
                <p>
                  <%= t('stories.show.destiny') %>: <%= decision.destiny_num %>
                </p>
                <hr/>
              <% end %>
            </div>
          <% end %>
          <% if chapter.monsters.present? %>
            <div class="monster-fields">
              <h3><%= t('stories.show.monsters') %></h3>
              <% chapter.monsters.each do |monster| %>
                <p>
                  <%= t('stories.show.name') %>: <%= monster.name %>
                </p>
                <p>
                  <%= t('stories.show.skill') %>: <%= monster.skill %>
                </p>
                <p>
                  <%= t('stories.show.energy') %>: <%= monster.energy %>
                </p>
              <% end %>
            </div>
          <% end %>
          <hr/>
        </div><br/>
      <% end %>

    </div>
    <div id="tabs-2">
      <% @special_attributes.each do |special_attribute| %>
        <p>
          <%= t('stories.show.special_attribute') %>: <%= special_attribute.name %>
        </p>
        <hr/>
      <% end %>
    </div>
    <div id="tabs-3">
      <% @items.each do |item| %>
        <p>
          <%= t('stories.show.item_name') %>: <%= item.name %>
        </p>
        <p>
          <%= t('stories.show.item_description') %>: <%= item.description %>
        </p>
        <hr>
      <% end %>
      <hr/>
    </div>
    <div id="tabs-4">
      <p>
        <b><%= t('stories.show.story_resume') %>:</b>
        <%= @story.resume %>
      </p>

      <p>
        <b><%= t('stories.show.prelude') %>:</b>
        <%= simple_format @story.prelude %>
      </p>
    </div>
    <div id="tabs-5">
      <div class="sigma" id="sig" >
      </div>
    </div>
  </div>

  <script type="text/javascript">
    $(document).ready(function(){

      $("#tabs").tabs({
        activate: function(event, ui) {
          if (ui.newPanel.attr("id") == "tabs-5") {

            $.ajax({
              url: "graph_json_show?id="+<%= @story.id %>,
              type: "GET",
              dataType: "json",
              success: function(data) {
                if (data["valid"]) {
                  var sigRoot = document.getElementById('sig');
                  var sigInst = sigma.init(sigRoot).drawingProperties({
                    defaultLabelColor: '#ccc',
                    defaultLabelSize: 10,
                    font: 'Arial',
                    edgeColor: 'source',
                    defaultEdgeType: 'curve',
                    defaultEdgeArrow: 'target',
                    labelThreshold: 0
                  }).graphProperties({
                    minNodeSize: 0.5,
                    maxNodeSize: 5,
                    maxEdgeSize: 3
                  }).mouseProperties({
                    maxRatio: 32
                  });

                  for (var i=0;i<data["references"].length;i++) {
                    sigInst.addNode('cap'+data["references"][i], {
                      label: 'cap '+data["references"][i],
                      color: data["infos"][i][2],
                      x: data["infos"][i][0],
                      y: data["infos"][i][1]
                    }).draw();
                  }

                  for (var k=0;k<data["chapter_destinies"].length;k++) {
                    if ((data["chapter_destinies"][k].length != 0) && data["valid"][k]) {
                      for (var l=1;l<data["chapter_destinies"][k].length;l++) {
                        sigInst.addEdge('cap'+data["chapter_destinies"][k][0]+'_cap'+data["chapter_destinies"][k][l], 'cap'+data["chapter_destinies"][k][0], 'cap'+data["chapter_destinies"][k][l]).draw();
                      }
                    }
                  }
                }

              }
            });

          }
        }
      });


    });
  </script>
  
</div>
