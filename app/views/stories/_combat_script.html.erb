<% if @chapter.monsters.present? %>
  <script type="text/javascript">
    $(document).ready(function() {
      var story_id = <%= @chapter.story.id %>;

      $("#combat").click(function() {
        var result = "";
        var finish;
        var morreu = false;
        var adventurer_skill = <%= @adventurer.skill %>;
        var adventurer_energy = <%= @adventurer.energy %>;
        var adventurer_luck = <%= @adventurer.luck %>;

        <% @chapter.monsters.each do |monster| %>
          var <%= monster.name.parameterize.underscore %>_skill = <%= monster.skill %>;
          var <%= monster.name.parameterize.underscore %>_energy = <%= monster.energy %>;

          finish = false;

          while (!finish) {
            var enemyDice1 = 1 + Math.floor(Math.random()*6);
            var enemyDice2 = 1 + Math.floor(Math.random()*6);
            var enemyAttackPower = enemyDice1 + enemyDice2 + <%= monster.name.parameterize.underscore %>_skill;
            var advDice1 = 1 + Math.floor(Math.random()*6);
            var advDice2 = 1 + Math.floor(Math.random()*6);
            var adventurerAttackPower = advDice1 + advDice2 + adventurer_skill;

            if (enemyAttackPower > adventurerAttackPower) {
              result += "<p>"+ "<%= @adventurer.name %> <%= t('stories.read.attack_power') %> - "+ advDice1 + " + " + advDice2 + " + " + adventurer_skill + " = "+ adventurerAttackPower + "<strong><br>" + "<%= monster.name %> <%= t('stories.read.attack_power') %> - "+ enemyDice1 + " + " + enemyDice2 + " + " + <%= monster.name.parameterize.underscore %>_skill + " = " + enemyAttackPower + "</strong></p><hr>";
              adventurer_energy -= 2;
              if (adventurer_energy < 1) {
                finish = true;
                morreu = true;
                result += "<p><%= t('stories.read.you_died') %></p>";
                $("#combat-result").html(result);
                return;
              } else if (<%= monster.name.parameterize.underscore %>_energy < 1) {
                finish = true;
                result += "<p><%= monster.name %> <%= t('stories.read.died') %></p>";
              }
            } else if (enemyAttackPower < adventurerAttackPower) {
              result += "<p><strong>"+ "<%= @adventurer.name %> <%= t('stories.read.attack_power') %> - "+ advDice1 + " + " + advDice2 + " + " + adventurer_skill + " = "+ adventurerAttackPower + "</strong> <i class='fa fa-check fa-1'></i><br>" + "<%= monster.name %> <%= t('stories.read.attack_power') %> - "+ enemyDice1 + " + " + enemyDice2 + " + " + <%= monster.name.parameterize.underscore %>_skill + " = " + enemyAttackPower + "</p><hr>";
              <%= monster.name.parameterize.underscore %>_energy -= 2;
              if (adventurer_energy < 1) {
                finish = true;
                morreu = true;
                result += "<p><%= t('stories.read.you_died') %></p>";
                $("#combat-result").html(result);
                return;
              } else if (<%= monster.name.parameterize.underscore %>_energy < 1) {
                finish = true;
                result += "<p><%= monster.name %> <%= t('stories.read.died') %></p>";
              }
            }
          }
        <% end %>
        $("#combat-result").html(result);
        $("#adventurer_energy").html(adventurer_energy);
        if (!morreu) {
          $('#chapter-buttons').children().find('a').each(function(){
            if ($(this).attr('data-donthave') != "true") {
              console.log($(this).attr('data-donthave'));
              $(this).removeClass('disabled');
            }
          });
        }
        $("#combat").addClass('disabled');

        $.ajax({
          url: "/adventurers/update_adventurer_status?adventurer_skill="+adventurer_skill+"&adventurer_energy="+adventurer_energy+"&adventurer_luck="+adventurer_luck+"&story_id="+story_id,
          type: 'PUT',
          success: function(data) {
            showMessage(data["message"]);
            $('#adventurer_skill').html(adventurer_skill);
            $('#adventurer_energy').html(adventurer_energy);
            $('#adventurer_luck').html(adventurer_luck);
            $('#adventurer_skill_bar').attr('aria-valuenow', adventurer_skill);
            $('#adventurer_energy_bar').attr('aria-valuenow', adventurer_energy);
            $('#adventurer_luck_bar').attr('aria-valuenow', adventurer_luck);
            $('#adventurer_skill_bar').css('width', (adventurer_skill / 12.0) * 100 + '%');
            $('#adventurer_energy_bar').css('width', (adventurer_energy / 24.0) * 100 + '%');
            $('#adventurer_luck_bar').css('width', (adventurer_luck / 12.0) * 100 + '%');
          },
          error: function(response) {
            showMessage(response["message"]);
          }
        });

      });

      function showMessage(message) {
        $('.message-container').fadeIn();
        $('.message-container').removeClass('alert alert-success');
        $('.message-container').removeClass('alert alert-danger');
        $('.message-container').addClass('alert alert-success');
        $('.message-container').html(message);
        $('.message-container').fadeOut(3000);
      }
    });
  </script>
<% end %>